name: Quality Gate Pipeline - Ø®Ø· Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø´Ø§Ù…Ù„
on:
  push:
    branches: [ main, develop, staging ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ======================== Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: ÙØ­Øµ Ø§Ù„ÙƒÙˆØ¯ ==========================
  lint-and-format:
    name: Lint & Code Format
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
        continue-on-error: false
      
      - name: Check TypeScript Types
        run: npx tsc --noEmit
        continue-on-error: false
      
      - name: Code Formatting Check
        run: npx prettier --check .
        continue-on-error: false

  # ======================== Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª ==========================
  unit-tests:
    name: Unit Tests (Jest/Vitest)
    runs-on: ubuntu-latest
    needs: lint-and-format
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Run Unit Tests
        run: npm run test:unit -- --coverage
      
      - name: Upload Coverage Reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
      
      - name: Check Coverage Threshold (80%)
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | grep -o '"lines":{"total":[^}]*' | grep -o '[0-9.]*' | tail -1)
          if [ "$(echo "$COVERAGE < 80" | bc)" -eq 1 ]; then
            echo "âŒ Test Coverage: $COVERAGE% (below 80% threshold)"
            exit 1
          fi
          echo "âœ… Test Coverage: $COVERAGE%"

  # ======================== Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªÙƒØ§Ù…Ù„ ==========================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Run Integration Tests
        run: npm run test:integration
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/abkhas_test
          REDIS_URL: redis://localhost:6379
      
      - name: Test Data Validation Rules
        run: npm run test:data-validation

  # ======================== Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª E2E ==========================
  e2e-tests:
    name: E2E Tests (Critical Journeys)
    runs-on: ubuntu-latest
    needs: [lint-and-format, unit-tests]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      
      - name: Build Application
        run: npm run build
      
      - name: Start Development Server
        run: npm run dev &
        continue-on-error: true
      
      - name: Wait for Server
        run: npx wait-on http://localhost:5173
      
      - name: Run E2E Tests
        run: npm run test:e2e
      
      - name: Upload E2E Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  # ======================== Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ==========================
  performance-tests:
    name: Performance & Load Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Build for Production
        run: npm run build
      
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v9
        with:
          configPath: './lighthouserc.json'
          uploadArtifacts: true
      
      - name: Performance Benchmark Test
        run: npm run test:performance
        continue-on-error: true
      
      - name: Bundle Size Check
        run: |
          SIZE=$(du -sh dist/ | awk '{print $1}')
          echo "Build Size: $SIZE"
          # Check if bundle size < 1MB (excluding assets)
          JS_SIZE=$(du -sh dist/*.js 2>/dev/null | awk '{sum+=$1} END {print sum}')
          if [ $JS_SIZE -gt 500000 ]; then
            echo "âš ï¸ Warning: JavaScript bundle > 500KB (Code splitting needed)"
          fi

  # ======================== Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6: ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù† ==========================
  security-scan:
    name: Security & Vulnerability Scan
    runs-on: ubuntu-latest
    needs: lint-and-format
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: Dependency Check
        run: npm run audit:dependencies
        continue-on-error: true
      
      - name: SAST Scan (SonarQube)
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

  # ======================== Ø§Ù„Ù…Ø±Ø­Ù„Ø© 7: Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯ ==========================
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Analyze Code Complexity
        run: npm run analyze:complexity
        continue-on-error: true
      
      - name: Generate Code Metrics
        run: npm run metrics
        continue-on-error: true
      
      - name: Check Code Smells
        run: npm run check:smells
        continue-on-error: true

  # ======================== Ø§Ù„Ù…Ø±Ø­Ù„Ø© 8: Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ==========================
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [e2e-tests, performance-tests, code-quality]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Build Production
        run: npm run build
      
      - name: Verify Build Output
        run: |
          test -d dist/ || exit 1
          test -f dist/index.html || exit 1
          echo "âœ… Build verified successfully"
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: production-build
          path: dist/
          retention-days: 30

  # ======================== Ø§Ù„Ù…Ø±Ø­Ù„Ø© 9: ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø© ==========================
  quality-report:
    name: Quality Report & Summary
    runs-on: ubuntu-latest
    needs: [lint-and-format, unit-tests, integration-tests, e2e-tests, build]
    if: always()
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Generate Quality Report
        run: npm run report:quality
        continue-on-error: true
      
      - name: Create PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('quality-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  # ======================== Ø§Ù„Ù…Ø±Ø­Ù„Ø© 10: Ø§Ù„Ù†Ø´Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ==========================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Download Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: production-build
          path: dist/
      
      - name: Deploy to Vercel
        uses: vercel/action@master
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: Notify Deployment
        run: |
          echo "âœ… Deployment successful!"
          echo "URL: https://abkhas.vercel.app"
          # Send Slack notification
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{"text":"ğŸš€ Abkhas deployed successfully to production"}'

  # ======================== Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø© (Quality Gates) ==========================
  quality-gate:
    name: Quality Gate Decision
    runs-on: ubuntu-latest
    needs: [lint-and-format, unit-tests, integration-tests, e2e-tests, security-scan]
    if: always()
    
    steps:
      - name: Check Quality Gates
        run: |
          echo "ğŸ” Checking Quality Gates..."
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
          LINT_STATUS="${{ needs.lint-and-format.result }}"
          UNIT_STATUS="${{ needs.unit-tests.result }}"
          INTEGRATION_STATUS="${{ needs.integration-tests.result }}"
          E2E_STATUS="${{ needs.e2e-tests.result }}"
          SECURITY_STATUS="${{ needs.security-scan.result }}"
          
          # Ø§Ù„Ù‚ÙˆØ§Ø¹Ø³ Ø§Ù„Ø­Ø±Ø¬Ø©
          if [ "$LINT_STATUS" != "success" ]; then
            echo "âŒ FAILED: Linting errors"
            exit 1
          fi
          
          if [ "$UNIT_STATUS" != "success" ]; then
            echo "âŒ FAILED: Unit tests"
            exit 1
          fi
          
          if [ "$E2E_STATUS" != "success" ]; then
            echo "âŒ FAILED: E2E tests (critical journeys)"
            exit 1
          fi
          
          # Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ØºÙŠØ± Ø§Ù„Ø­Ø±Ø¬Ø©
          if [ "$INTEGRATION_STATUS" != "success" ]; then
            echo "âš ï¸ WARNING: Integration tests (non-blocking)"
          fi
          
          if [ "$SECURITY_STATUS" != "success" ]; then
            echo "âš ï¸ WARNING: Security scan (review required)"
          fi
          
          echo "âœ… All critical quality gates passed!"

# ======================== Ø§Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø¹Ø§Ù… ==========================
# Environment Variables
env:
  CI: true
  NODE_ENV: test

# GitHub Actions Permissions
permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write
  security-events: write

# ======================== Ù…Ù„Ø®Øµ Ø®Ø· Ø§Ù„Ø¬ÙˆØ¯Ø© ==========================
#
# ğŸ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù:
# 1. Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ù†Ø´Ø± Ø£ÙƒÙˆØ§Ø¯ Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ø¬ÙˆØ¯Ø©
# 2. Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ù…Ø¨ÙƒØ±Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬
# 3. Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø£Ù…Ø§Ù†
# 4. ØªÙˆÙÙŠØ± ØªÙ‚Ø§Ø±ÙŠØ± Ø´ÙØ§ÙØ© Ù„Ù„ÙØ±ÙŠÙ‚
#
# âœ… Ø§Ù„Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø© (ÙŠØ¬Ø¨ Ø£Ù† ØªÙ†Ø¬Ø­ 100%):
# - ESLint & TypeScript checks
# - Unit Tests (80%+ coverage)
# - Critical E2E Tests
#
# âš ï¸ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø§Øª ØºÙŠØ± Ø§Ù„Ø­Ø±Ø¬Ø© (ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙÙ‚Ø·):
# - Integration tests
# - Performance tests
# - Security scan
#
# â±ï¸ ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ°: ~15-20 Ø¯Ù‚ÙŠÙ‚Ø© Ù„ÙƒÙ„ PR
#
# ğŸ’° Ø§Ù„ÙØ§Ø¦Ø¯Ø©:
# - Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø£Ø¹Ø·Ø§Ù„: 40% Ø£Ø³Ø±Ø¹
# - ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©: 70%
# - Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø«Ù‚Ø©: +30% ÙÙŠ Ø§Ù„ÙØ±ÙŠÙ‚ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
#
# ğŸš€ Ø§Ù„Ù†ØªÙŠØ¬Ø©:
# Ù„Ø§ ÙŠØªÙ… Ù†Ø´Ø± Ø£ÙŠ ÙƒÙˆØ¯ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ù…Ø±ÙˆØ± ÙƒÙ„ Ø§Ù„ÙØ­ÙˆØµØ§Øª
# = ØªØ·Ø¨ÙŠÙ‚ Ù…ÙˆØ«ÙˆÙ‚ Ø¯Ø§Ø¦Ù…Ø§Ù‹ = Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…Ø³ØªÙ‚Ø±Ø©
