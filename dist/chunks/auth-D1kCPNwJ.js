const f="abkhas_users",u="abkhas_current_user";const A=()=>`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,d=async r=>{const n=new TextEncoder().encode(r+"abkhas_salt_key_2024"),a=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(a)).map(s=>s.toString(16).padStart(2,"0")).join("")},h=async(r,e)=>await d(r)===e,m=()=>{try{const r=localStorage.getItem(f);return r?JSON.parse(r):[]}catch{return[]}},i=r=>{localStorage.setItem(f,JSON.stringify(r))},_=r=>{const e=r.replace(/[\s\-+]/g,"");return[/^5\d{8}$/,/^05\d{8}$/,/^9665\d{8}$/].some(a=>a.test(e))},S=r=>{let e=r.replace(/[\s\-]/g,"").trim();return e.startsWith("+")&&(e=e.substring(1)),e.startsWith("05")?"966"+e.substring(1):e.startsWith("5")&&e.length===9?"966"+e:(e.startsWith("966")&&e.length===12,e)},E=r=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r),O=async(r,e,n)=>{try{const a=r.trim(),t=n?.trim();if(!E(a))return{success:!1,message:"Invalid email format",error:"INVALID_EMAIL"};if(e.length<8)return{success:!1,message:"Password must be at least 8 characters",error:"WEAK_PASSWORD"};if(!/[a-z]/.test(e)||!/[A-Z]/.test(e)||!/[0-9]/.test(e))return{success:!1,message:"Password must contain uppercase, lowercase, and numbers",error:"WEAK_PASSWORD"};const s=m(),o=a.toLowerCase();if(s.some(g=>g.email===o))return{success:!1,message:"Email already registered",error:"EMAIL_EXISTS"};const c=await d(e),l={id:A(),email:o,passwordHash:c,createdAt:Date.now(),lastLogin:Date.now(),loginAttempts:0,profileData:{name:t||a.split("@")[0]}};return s.push(l),i(s),localStorage.setItem(u,JSON.stringify(l)),{success:!0,message:"Registration successful",user:l}}catch(a){return{success:!1,message:"Registration failed",error:a instanceof Error?a.message:"UNKNOWN_ERROR"}}},N=async(r,e,n)=>{try{const a=r.trim(),t=n?.trim();if(!_(a))return{success:!1,message:"Invalid Saudi phone number",error:"INVALID_PHONE"};if(e.length<8)return{success:!1,message:"Password must be at least 8 characters",error:"WEAK_PASSWORD"};if(!/[a-z]/.test(e)||!/[A-Z]/.test(e)||!/[0-9]/.test(e))return{success:!1,message:"Password must contain uppercase, lowercase, and numbers",error:"WEAK_PASSWORD"};const s=S(a),o=m();if(o.some(g=>g.phoneNumber===s))return{success:!1,message:"Phone number already registered",error:"PHONE_EXISTS"};const c=await d(e),l={id:A(),phoneNumber:s,passwordHash:c,createdAt:Date.now(),lastLogin:Date.now(),loginAttempts:0,profileData:{name:t||`User ${s.slice(-4)}`}};return o.push(l),i(o),localStorage.setItem(u,JSON.stringify(l)),{success:!0,message:"Registration successful",user:l}}catch(a){return{success:!1,message:"Registration failed",error:a instanceof Error?a.message:"UNKNOWN_ERROR"}}},p=async(r,e)=>{try{const n=r.trim();if(!E(n))return{success:!1,message:"Invalid email format",error:"INVALID_EMAIL"};const a=m(),t=a.find(o=>o.email===n.toLowerCase());if(!t)return{success:!1,message:"Email not found",error:"USER_NOT_FOUND"};if(t.lockedUntil&&t.lockedUntil>Date.now()){const o=Math.ceil((t.lockedUntil-Date.now())/6e4);return{success:!1,message:`Account locked. Try again in ${o} minute${o>1?"s":""}`,error:"ACCOUNT_LOCKED"}}return await h(e,t.passwordHash)?(t.loginAttempts=0,t.lockedUntil=void 0,t.lastLogin=Date.now(),i(a),localStorage.setItem(u,JSON.stringify(t)),{success:!0,message:"Login successful",user:t}):(t.loginAttempts=(t.loginAttempts||0)+1,t.loginAttempts>=5?(t.lockedUntil=Date.now()+9e5,i(a),{success:!1,message:"Too many failed attempts. Account locked for 15 minutes",error:"ACCOUNT_LOCKED"}):(i(a),{success:!1,message:`Invalid password. ${5-t.loginAttempts} attempt${5-t.loginAttempts>1?"s":""} remaining`,error:"INVALID_PASSWORD"}))}catch(n){return{success:!1,message:"Login failed",error:n instanceof Error?n.message:"UNKNOWN_ERROR"}}},I=async(r,e)=>{try{const n=r.trim();if(!_(n))return{success:!1,message:"Invalid Saudi phone number",error:"INVALID_PHONE"};const a=S(n),t=m(),s=t.find(c=>c.phoneNumber===a);if(!s)return{success:!1,message:"Phone number not found",error:"USER_NOT_FOUND"};if(s.lockedUntil&&s.lockedUntil>Date.now()){const c=Math.ceil((s.lockedUntil-Date.now())/6e4);return{success:!1,message:`Account locked. Try again in ${c} minute${c>1?"s":""}`,error:"ACCOUNT_LOCKED"}}return await h(e,s.passwordHash)?(s.loginAttempts=0,s.lockedUntil=void 0,s.lastLogin=Date.now(),i(t),localStorage.setItem(u,JSON.stringify(s)),{success:!0,message:"Login successful",user:s}):(s.loginAttempts=(s.loginAttempts||0)+1,s.loginAttempts>=5?(s.lockedUntil=Date.now()+9e5,i(t),{success:!1,message:"Too many failed attempts. Account locked for 15 minutes",error:"ACCOUNT_LOCKED"}):(i(t),{success:!1,message:`Invalid password. ${5-s.loginAttempts} attempt${5-s.loginAttempts>1?"s":""} remaining`,error:"INVALID_PASSWORD"}))}catch(n){return{success:!1,message:"Login failed",error:n instanceof Error?n.message:"UNKNOWN_ERROR"}}},T=()=>{try{const r=localStorage.getItem(u);return r?JSON.parse(r):null}catch{return null}},w=()=>{localStorage.removeItem(u),sessionStorage.clear()};export{I as a,N as b,_ as c,w as d,T as g,p as l,O as r,E as v};
